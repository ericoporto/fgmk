<!DOCTYPE html> 

<html> 
	
<head> 
        
<title> fgmk Game
</title> 

		
<style>
@font-face {
    font-family: 'INFO56';
    src: url('font/INFO56_0.ttf');
}

body{
    background-color: black;
	padding: 0px;
	margin: 0px;
    overflow:hidden;
}

canvas {
    display: block;
    margin:0 auto 0 auto;
}

#viewport {
    width: 100%;
    height: 100%;


    image-rendering: -moz-crisp-edges;
    image-rendering: -o-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    -ms-interpolation-mode: nearest-neighbor;
}
</style>
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, user-scalable=0" /> 
        
<meta name="apple-mobile-web-app-capable" content="yes" /> 
        
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /> 
        
<link rel="icon" sizes="192x192" href="icon.png"> 
		
<meta charset="UTF-8"/> 


		
<script>
function clone(existingArray){var newObj=existingArray instanceof Array?[]:{};for(i in existingArray){if(i=="clone")continue;if(existingArray[i]&&typeof existingArray[i]=="object"){newObj[i]=clone(existingArray[i])}else{newObj[i]=existingArray[i]}}return newObj}getkey0=function(tree,key){if(key in tree)return tree[key];else return 0};function removeA(arr){var what,a=arguments,L=a.length,ax;while(L>1&&arr.length){what=a[--L];while((ax=arr.indexOf(what))!==-1){arr.splice(ax,1)}}return arr}window.mobilecheck=function(){return window.forceMobile||window.__mobilecheck()};jsonGet=function(urlToGet){var request=new XMLHttpRequest;request.open("get",urlToGet,false);request.send();var json=request.responseText;return JSON.parse(json)};window.__mobilecheck=function(){var check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};window.isFirefox=function(){var check=false;(function(a){if(/firefox/i.test(a))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};</script>

<script>
var descriptors="descriptors/";var charaset="charaset/";var levelsFolder="levels/";var charasetsFolder="charaset/";var charasFolder="charas/";var resources={tileset:null,playerChara:null,printerset:null,playerCharaset:null,faceset:null,feedback:{},items:{},levels:{},charasets:{},charas:{},hms:{}};resources.harvest=function(){var filecount=0;document.getElementsByTagName("canvas")[0].getContext("2d").fillStyle="#FFFFFF";var getresource=function(getthis){var toreturn=jsonGet(getthis);if(!(typeof toreturn.resources==="undefined")){if(!(typeof toreturn.resources.audio==="undefined")){}}filecount+=1;if(!(typeof toreturn.Level==="undefined")){document.getElementsByTagName("canvas")[0].getContext("2d").fillText(".",filecount,filecount)}return toreturn};this.tileset=document.getElementById("tile");this.faceset=document.getElementById("faceset");this.charasetimg=document.getElementById("charasetimg");this.printerset=document.getElementById("printerimg");this.monsterimg=document.getElementById("monsterbattleimg");this.pictures={};this.pictures.title=document.getElementById("titleimg");this.pictures.keys0=document.getElementById("keys0");this.pictures.keys1=document.getElementById("keys1");this.pictures.keys2=document.getElementById("keys2");this.pictures.controllers=document.getElementById("controllers");this.feedback=getresource(descriptors+"feedback.json")["Feedback"];LevelsList=init["LevelsList"];for(var level in LevelsList){var levelItem=LevelsList[level];console.log(descriptors+levelsFolder+levelItem);resources["levels"][level]=getresource(descriptors+levelsFolder+levelItem)}CharasetFileList=init["CharasetFileList"];for(var charasetfilep in CharasetFileList){var charasetfile=CharasetFileList[charasetfilep];console.log(descriptors+charasetsFolder+charasetfile);resources["charasets"]=getresource(descriptors+charasetsFolder+charasetfile)["Charaset"]}resources["charas"]=getresource(descriptors+"charas.json")["Charas"];this.playerCharaset=resources["charasets"][init["Player"]["charaSet"]];this.hms=getresource(descriptors+init["HMSFile"]);this.items=getresource(descriptors+init["itemsFile"])["Items"]};</script>

<script>
function rain(__context,__width,__height,___screen){var that=this;var ___context=__context;var rainBufferCanvas=null;var rainBufferCanvasCtx=null;var particles=[];var removeparticles=[];var RainDropTimer=null;var stop=false;var colors=[];var rainBufferWidth=typeof __width==="undefined"?416:__width;var rainBufferHeight=typeof __height==="undefined"?416:__height;this.raining=false;function toColor(num){var g=Math.min(Math.round(num),255);return"rgba("+[g,g,g].join(",")+",1)"}function addRainDrop(){particles[particles.length]=new RainDrop;if(particles.length==that.maxRainDrops)clearInterval(RainDropTimer)}this.startRain=function(){for(var i=0;i<7;i++){colors[i]=toColor(i*128/6+128)}that.raining=true;stop=false;that.maxRainDrops=200;rainBufferCanvas=document.createElement("canvas");rainBufferCanvasCtx=rainBufferCanvas.getContext("2d");rainBufferCanvasCtx.mozImageSmoothingEnabled=false;rainBufferCanvasCtx.canvas.width=rainBufferWidth;rainBufferCanvasCtx.canvas.height=rainBufferHeight;RainDropTimer=setInterval(addRainDrop,200)};this.stopRain=function(){stop=true;clearInterval(RainDropTimer)};function blankRainBC(){var npart=particles.length;rainBufferCanvasCtx.clearRect(0,0,rainBufferCanvasCtx.canvas.width,rainBufferCanvasCtx.canvas.height);if(npart>50){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.2)"}else if(npart>35){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.15)"}else if(npart>25){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.1)"}else if(npart>20){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.075)"}else if(npart>15){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.05)"}else if(npart>10){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.025)"}if(npart>10){rainBufferCanvasCtx.fillRect(0,0,rainBufferCanvasCtx.canvas.width,rainBufferCanvasCtx.canvas.height)}}function DrawRainColor(colori){rainBufferCanvasCtx.beginPath();for(var i=0;i<particles.length;i++){if(colori==particles[i].color){rainBufferCanvasCtx.moveTo(particles[i].x,particles[i].y);rainBufferCanvasCtx.lineTo(particles[i].x+particles[i].width,particles[i].y+particles[i].height)}}rainBufferCanvasCtx.strokeStyle=colors[colori];rainBufferCanvasCtx.stroke()}this.DrawRain=function(){if(that.raining){for(var i=0;i<particles.length;i++){if(particles[i].y<rainBufferHeight){particles[i].y+=particles[i].speed;if(particles[i].y>=rainBufferHeight){particles[i].y=-5;if(stop){removeparticles.push(i)}}particles[i].x+=particles[i].drift;if(particles[i].x>rainBufferWidth){particles[i].x=0;if(stop){removeparticles.push(i)}}}}if(particles.length>0){blankRainBC();for(var k=2;k<6;k++){DrawRainColor(k)}___context.drawImage(rainBufferCanvas,___screen.GSTARTX,___screen.GSTARTY,rainBufferWidth,rainBufferHeight)}if(removeparticles.length>0){removeparticles.sort(function(a,b){return b-a});while(removeparticles.length>0){particles.splice(removeparticles.pop(),1)}if(particles.length==0){that.raining=false}}}};function RainDrop(){var angle=2;this.x=Math.round(Math.random()*rainBufferWidth);this.y=-10;this.drift=Math.round(Math.random()*4)+2;this.speed=this.drift*angle;this.width=8;this.height=8*angle;this.color=this.drift}}</script>

<script>
items={};items.setup=function(itemsjson){this.inventory={};this.allitems={};this.allitems=itemsjson;this.defaultItem=function(){return{equipable:false,equiped:false,usable:false,unique:false,effect:null,statMod:null,description:false,name:null,icon:null,category:null,action:null,quantity:1}};this.addItem=function(itemname){if(itemname in this.inventory){if(!this.inventory[itemname].unique){this.inventory[itemname].quantity+=1}}else if(itemname in this.allitems){var item=this.defaultItem();for(var key in this.allitems[itemname]){item[key]=this.allitems[itemname][key]}if(item["name"]==null){item["name"]=itemname}this.inventory[itemname]=item}this.menuUpdate(engine.mapMenu)};this.subtractItem=function(itemname){this.inventory[itemname].quantity-=1;if(this.inventory[itemname].quantity<=0){this.deleteItem(itemname)}this.menuUpdate(engine.mapMenu)};this.deleteItem=function(itemname){delete this.inventory[itemname]};this.effect={};this.pts=function(itemname){var baseplus=getkey0(this.inventory[itemname].effect,"basep");var plus=getkey0(this.inventory[itemname].effect,"plus");var attribut=getkey0(this.inventory[itemname].effect,"atr");return Math.max(battle.diceroll(baseplus+attribut)+plus,0)};this.effect.hpup=function(target,pts){target.hp=Math.min(target.hp+pts,target.hpmax)};this.useItem=function(itemname){if(this.inventory[itemname].action==null){var points=this.pts(itemname);var target=[];target.push(battle.heroes[player.party[0]]);var effects=this.inventory[itemname].effect.effect;for(var j=0;j<target.length;j++){for(var i=0;i<effects.length;i++){this.effect[effects[i]](target[j],points)}}this.subtractItem(itemname)}};this.equipItem=function(itemname){if(player.party.length==1){var currHero=battle.heroes[player.party[0]];var heroname=player.party[0];var eq_item=this.inventory[itemname];if(currHero.equiped[eq_item.category]){}else{eq_item.equiped=heroname;currHero.equiped[eq_item.category]=itemname;if(eq_item.statMod){if(!(typeof eq_item.statMod.st==="undefined")){currHero.mod.st+=eq_item.statMod.st}if(!(typeof eq_item.statMod.dx==="undefined")){currHero.mod.dx+=eq_item.statMod.dx}if(!(typeof eq_item.statMod.iq==="undefined")){currHero.mod.iq+=eq_item.statMod.iq}}}}this.menuUpdate(engine.mapMenu)};this.unequipItem=function(itemname){if(player.party.length==1){var currHero=battle.heroes[player.party[0]];var heroname=player.party[0];var eq_item=this.inventory[itemname];if(currHero.equiped[eq_item.category]==itemname&&eq_item.equiped==heroname){if(eq_item.statMod){if(!(typeof eq_item.statMod.st==="undefined")){currHero.mod.st-=eq_item.statMod.st}if(!(typeof eq_item.statMod.dx==="undefined")){currHero.mod.dx-=eq_item.statMod.dx}if(!(typeof eq_item.statMod.iq==="undefined")){currHero.mod.iq-=eq_item.statMod.iq}}eq_item.equiped=false;currHero.equiped[eq_item.category]=false}else{console.log("tried to unequip item, but it wasn't equiped!")}}this.menuUpdate(engine.mapMenu)};this.lookItem=function(itemname){if(this.inventory[itemname].description){actions.showText(this.inventory[itemname].description)}};this.dropItem=function(itemname){this.subtractItem(itemname)};this.getMenu=function(){return this.menu};this.menuUpdate=function(mapmenu){if(!(typeof this.menu==="undefined")){var wasenable=this.menu.enabled;this.menu.enabled=false;this.menu.mdelete()}else{var wasenable=false;this.menu={}}var items2add={};var i=0;for(var iitem in this.inventory){var item=this.inventory[iitem].name;var k=0;var itemactions={};if(this.inventory[iitem].equipable){if(this.inventory[iitem].equiped){itemactions["unequip"]={};itemactions["unequip"]["index"]=k;itemactions["unequip"]["action"]=[function(){items.unequipItem(iitem)},"exit"]}else{itemactions["equip"]={};itemactions["equip"]["index"]=k;itemactions["equip"]["action"]=[function(){items.equipItem(iitem)},"exit"]}k++}if(this.inventory[iitem].usable){itemactions["use"]={};itemactions["use"]["index"]=k;itemactions["use"]["action"]=[function(){items.useItem(iitem)},"exit"];k++}if(this.inventory[iitem].description){itemactions["look"]={};itemactions["look"]["index"]=k;itemactions["look"]["action"]=[function(){items.lookItem(iitem)},"exit"];k++}if(!this.inventory[iitem].unique){itemactions["drop"]={};itemactions["drop"]["index"]=k;itemactions["drop"]["action"]=[function(){items.dropItem(iitem)},"exit"];k++}itemactions["back"]={};itemactions["back"]["action"]="exit";itemactions["back"]["index"]=k++;items2add[item]=new menu(itemactions,i);i++}if(i==0){items2add["empty"]={};items2add["empty"]["action"]=function(){};items2add["empty"]["index"]=i;i++}items2add["back"]={};items2add["back"]["action"]="exit";items2add["back"]["index"]=i;i++;this.menu=new menu(items2add,0);if(typeof mapmenu==="undefined"){menus.setParent(this.menu)}else{mapmenu.items.items=this.menu;mapmenu.updateOrder();menus.setParent(mapmenu)}menus.setAllDrawables();this.menu.enabled=wasenable}};</script>

<script>
var menus={allMenus:[],isAnyMenuEnabled:function(){var returnValue=false;for(var _menu in this.allMenus){if(this.allMenus[_menu].enabled){returnValue=true}}return returnValue},updateMenuEnabled:function(){var returnValue=null;for(var _menu in this.allMenus){if(this.allMenus[_menu].enabled){this.allMenus[_menu].update()}}return returnValue},setParent:function(o){if(o.items!=undefined){for(n in o.items){o.items[n].parent=o;this.setParent(o.items[n])}}},setDrawables:function(menuToDraw){if(menuToDraw.parent==null){menuToDraw["drawx"]=16;menuToDraw["drawy"]=16;menuToDraw["height"]=menuToDraw.itemsLength*32+32;menuToDraw["width"]=menuToDraw.maxItemStringSize()*13+32}else{menuToDraw["drawx"]=menuToDraw.parent.drawx+menuToDraw.parent.width;menuToDraw["drawy"]=menuToDraw.parent.drawy;menuToDraw["height"]=menuToDraw.itemsLength*32+32;menuToDraw["width"]=menuToDraw.maxItemStringSize()*13+32}},setAllDrawables:function(){for(var anotherMenu in this.allMenus){for(var aMenu in this.allMenus){this.setDrawables(this.allMenus[aMenu])}}}};function menu(_items,_index,_noexit){var tempArray=[];_index=typeof _index==="undefined"?null:_index;_noexit=typeof _noexit==="undefined"?false:true;this.items=_items;this.noexit=_noexit;this.parent=null;this.index=_index;this.enabled=false;this.selectedItem=null;this.wait=false;this.isMenu=true;this.updateOrder=function(){for(var i=0;i<Object.keys(this.items).length;i++){var _itemKey=Object.keys(this.items)[i];tempArray[i]=[_itemKey,this.items[_itemKey].index]}tempArray.sort(function(a,b){return a[1]-b[1]});this.selectedItem=this.items[tempArray[0][0]];for(var i=0;i<tempArray.length;i++){if(i==0){this.items[tempArray[i][0]].previous=tempArray[0][0];this.items[tempArray[i][0]].next=tempArray[i+1][0]}else if(i==tempArray.length-1){this.items[tempArray[i][0]].previous=tempArray[i-1][0];this.items[tempArray[i][0]].next=tempArray[i][0]}else{this.items[tempArray[i][0]].previous=tempArray[i-1][0];this.items[tempArray[i][0]].next=tempArray[i+1][0]}this.items[tempArray[i][0]].itemy=32+i*32}if(this.selectedItem==null)this.selectedItem=this.items[Object.keys(this.items)[0]];this.selectedItem.selected=true};this.updateOrder();this.maxItemStringSize=function(){var returnValue=0;for(var i=0;i<Object.keys(this.items).length;i++){var _itemKey=Object.keys(this.items)[i];if(returnValue<_itemKey.length){returnValue=_itemKey.length}}return returnValue};this.itemsLength=Object.keys(_items).length;this.exit=function(){this._counter=0;this.enabled=false;HID.inputs["cancel"].active=false;engine.waitTime(200);if(this.parent!=null){this.parent.wait=false;this.parent.menuKeyWasPressed=32}else{engine.atomStack.push(engine.atomStack.push([function(){engine.atomStack=menus.holdAtomStack},""]),"")}};this.activate=function(){this.enabled=true;if(this.parent!=null){this.parent.wait=true}else{menus.holdAtomStack=engine.atomStack;engine.atomStack=new Array}};this._counter=0;this.menuKeyWasPressed=0;this.update=function(){if(this._counter<20)this._counter+=1;if(this.menuKeyWasPressed==0){if(!this.wait){if(HID.inputs["up"].active){this.selectedItem.selected=false;this.selectedItem=this.items[this.selectedItem.previous];this.selectedItem.selected=true;HID.inputs["up"].active=false;this.menuKeyWasPressed=32}else if(HID.inputs["left"].active){}else if(HID.inputs["right"].active){}else if(HID.inputs["down"].active){this.selectedItem.selected=false;this.selectedItem=this.items[this.selectedItem.next];this.selectedItem.selected=true;HID.inputs["down"].active=false;this.menuKeyWasPressed=32}else if(HID.inputs["accept"].active){HID.inputs["accept"].active=false;if(this.selectedItem.action=="exit"){this.exit()}else if(Object.prototype.toString.call(this.selectedItem.action)==="[object Array]"){for(var i=0;i<this.selectedItem.action.length;i++){if(this.selectedItem.action[i]=="exit"){this.exit()}else if(this.selectedItem.action[i]=="goWait"){engine.atomStack.push([function(){this.wait=true},""])}else if(this.selectedItem.action[i]=="stopWait"){engine.atomStack.push([function(){this.wait=false},""])}else{this.selectedItem.action[i]()}}}else{if(typeof this.selectedItem.isMenu==="undefined"){this.selectedItem.action()}else{this.selectedItem.menuKeyWasPressed=32;this.selectedItem.action()}}this.menuKeyWasPressed=32}else if(HID.inputs["cancel"].active){if(this._counter>=20&&this.noexit==false){HID.inputs["cancel"].active=false;this.exit();engine.waitTime(200);this.menuKeyWasPressed=32}}}}else{this.menuKeyWasPressed-=4}};this.action=this.activate;this.mdelete=function(){for(var i=0;i<menus.allMenus.length;i++){if(menus.allMenus[i]==this){menus.allMenus.splice(i,1);break}}};menus.allMenus.push(this)}</script>

<script>
feedbackEng={};feedbackEng.setup=function(){this.once=false,this.timer=null,this.vibrationOn=false,this.soundOn=false;this.flist={};this.loadedSounds={};this.vibrate=null;this.flist=resources.feedback;navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate;if(navigator.vibrate){this.vibrationOn=true}if(window.isFirefox()){this.soundOn=true}for(var sound in this.flist){this.loadedSounds[sound]=document.getElementById(this.flist[sound].s)}};feedbackEng.play=function(feedback){if(this.once==false){if(this.vibrationOn){navigator.vibrate(this.flist[feedback].v)}if(this.soundOn){this.loadedSounds[feedback].cloneNode(true).play()}}};feedbackEng.turnOnceOffTime=function(){this.timer=setTimeout(function(){feedbackEng.once=false},100)};bgmusic={setup:function(){},play:function(){}};</script>

<script>
var chars=[];var engine={};window.ondevicemotion=function(event){if(event.accelerationIncludingGravity.y>4){player["running"]=false}else{player["running"]=true}};function charalist(){if("charas"in engine.currentLevel["Level"]){listofcharas=engine.currentLevel["Level"]["charas"];if(listofcharas[0]==""){return[]}var count=listofcharas.length;var returnvalue=[];for(var i=0;i<count;i++){var item=listofcharas[i];returnvalue.push(new char(item[0],item[1],item[2]))}return returnvalue}else{return[]}}engine.checkMapBoundaries=function(_char,px,py,mapw,maph){if(_char.facing=="up"){return py>0}else if(_char.facing=="left"){return px>0}else if(_char.facing=="right"){return px<mapw}else if(_char.facing=="down"){return py<maph}return True};engine.facingPosition=function(_char,px,py){var facing=_char.facing;if(facing=="up"){return[py-1,px]}else if(facing=="left"){return[py,px-1]}else if(facing=="right"){return[py,px+1]}else{return[py+1,px]}console.log("error facing! char: "+_char+" ;position: "+px+", "+py);return false};engine.charWalkSteps=function(_char,walkSteps){_char.steps-=walkSteps;if(_char.facing=="up"){_char.mapy-=walkSteps}else if(_char.facing=="left"){_char.mapx-=walkSteps}else if(_char.facing=="right"){_char.mapx+=walkSteps}else if(_char.facing="down"){_char.mapy+=walkSteps}};engine.charaLookToPlayer=function(chara){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(chara.mapx/32),cpy=Math.floor(chara.mapy/32)+1;var resx=cpx-ppx;var resy=cpy-ppy;if(resx==0&&resy<0){return"down"}else if(resx==0&&resy>0){return"up"}else if(resx<0){return"right"}else{return"left"}console.log("error facing!"+resx+" , "+resy);return false};engine.randomDirection=function(){var directions=["down","up","right","left","down"];return directions[Math.floor(Math.random()*4)]};engine.isCharFacingPlayer=function(_char){var ppx=Math.floor(_char.mapx/32),ppy=Math.floor(_char.mapy/32)+1;var cpx=Math.floor(player.mapx/32),cpy=Math.floor(player.mapy/32)+1;if(ppx-cpx==1&&cpy-ppy==0&&_char.facing=="left"){return true}else if(ppx-cpx==-1&&cpy-ppy==0&&_char.facing=="right"){return true}else if(ppx-cpx==0&&cpy-ppy==1&&_char.facing=="down"){return true}else if(ppx-cpx==0&&cpy-ppy==-1&&_char.facing=="up"){return true}return false};function char(chara,x,y){this["chara"]=resources["charas"][chara];this["nocolision"]=this.chara.properties.nocolision;this["charaset"]=resources["charasets"][this["chara"]["charaset"]];this["facing"]="down";this["steps"]=0;this["waits"]=0;this["mapx"]=x*32;this["mapy"]=(y-1)*32;this["movstack"]=clone(this["chara"]["movements"]);this["stopped"]=false;this["mapwidth"]=engine.currentLevel["Level"]["colision"].length,this["mapheight"]=engine.currentLevel["Level"]["colision"][0].length-1;this["checkMapBoundaries"]=function(px,py,mapw,maph){return engine.checkMapBoundaries(this,px,py,mapw,maph)};this["facingPosition"]=function(px,py){return engine.facingPosition(this,px,py)};this["isFacingPlayer"]=function(){return engine.isCharFacingPlayer(this)};this["imediate"]=this.chara.actions.type[1]==1;this["followPlayer"]=function(){this.facing=engine.charaLookToPlayer(this)};this["update"]=function(){if(printer.isShown)return;if(this.steps==0&&this.waits==0&&this.stopped==false){if(this["movstack"].length>0){var px=Math.floor(this.mapx/32),py=Math.floor(this.mapy/32)+1;var moveToDo=this["movstack"].shift();if(moveToDo[0]=="move"){if(moveToDo[1]=="follow"){this.followPlayer()}else if(moveToDo[1]=="random"){this.facing=engine.randomDirection()}else{this.facing=moveToDo[1]}var fpos=this.facingPosition(px,py);if(this.imediate){if(this.isFacingPlayer()){var playerpx=Math.floor(player.mapx/32),playerpy=Math.floor(player.mapy/32)+1;eventInChar(this,[0,1],[playerpy-1,playerpx])}}if(this.checkMapBoundaries(px,py,this.mapwidth,this.mapheight)&&engine.currentLevel["Level"]["colision"][fpos[0]][fpos[1]]==0){this.steps=32}else{this.waits=16}}if(moveToDo[0]=="face"){if(moveToDo[1]=="follow"){this.followPlayer()}else if(moveToDo[1]=="random"){this.facing=engine.randomDirection()}else{this.facing=moveToDo[1]}this.waits=16}}else{if(this["chara"]["movements"]!=[]){this["movstack"]=clone(this["chara"]["movements"])}}}else if(this.steps>0&&this.waits==0&&this.stopped==false){engine.charWalkSteps(this,1)}else if(this.waits>0&&this.stopped==false){this.waits-=2}}}var player={};player.setup=function(){player["charaset"]=resources.playerCharaset;player["mapx"]=init["Player"]["initPosX"];player["mapy"]=init["Player"]["initPosY"];player["facing"]=init["Player"]["facing"];player["party"]=init["Player"]["party"];player["steps"]=0;player["waits"]=0;player["running"]=false;player["checkMapBoundaries"]=function(px,py,mapw,maph){return engine.checkMapBoundaries(player,px,py,mapw,maph)};player["update"]=function(){if(printer.isShown)return;var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;var mapwidth=engine.currentLevel["Level"]["colision"].length;var mapheight=engine.currentLevel["Level"]["colision"][0].length-1;if(player.steps==0&&player.waits==0){var dirkey=engine.dirKeyActive();if(dirkey){player.mapx=px*32,player.mapy=(py-1)*32;player.facing=dirkey;var fpos=player.facingPosition();if(player.checkMapBoundaries(px,py,mapwidth,mapheight)){var charFacing=engine.playerFaceChar();if(engine.currentLevel["Level"]["colision"][fpos[0]][fpos[1]]==0&&!charFacing.nocolision){player.steps=32;if(charFacing){eventInChar(charFacing,[0,1],[py-1,px])}if(engine.currentLevel["Level"]["events"][fpos[0]][fpos[1]]!=0){eventInMap(engine.currentLevel["Level"],engine.currentLevel["Level"]["events"][fpos[0]][fpos[1]],[0,1],fpos);HID.inputs["accept"].active=false;engine.waitTime(400)}}else{feedbackEng.play("stop");HID.inputs[dirkey].active=false}}else{feedbackEng.play("stop");HID.inputs[dirkey].active=false}}else if(HID.inputs["accept"].active){var charFacing=engine.playerFaceChar();if(charFacing){if(eventInChar(charFacing,[1,0],[py-1,px])){HID.inputs["accept"].active=false;engine.waitTime(400)}else{player.waits=16}}else{if(py-1>0&&px-1>0&&px+1<engine.currentLevel["Level"]["events"].length&&px+1<engine.currentLevel["Level"]["events"].length){var pos=player.facingPosition();if(engine.currentLevel["Level"]["events"][pos[0]][pos[1]]!=0){eventInMap(engine.currentLevel["Level"],engine.currentLevel["Level"]["events"][pos[0]][pos[1]],[1,0],pos);HID.inputs["accept"].active=false;engine.waitTime(400)}}}}else if(HID.inputs["cancel"].active){HID.inputs["cancel"].active=false;engine.mapMenu.activate()}}else if(player.waits==0){engine.charWalkSteps(player,2);if(player.running){if(!(player.steps==0)){engine.charWalkSteps(player,2)}}}else{player.waits-=1}}};engine.resetBlocks=function(){actions.blockCounter=0;actions.blockStack=new Array;actions.blockStack.push(actions.blockCounter.valueOf())};engine.setup=function(){engine.currentLevel=null;engine.levels=null;engine.paused=false;engine.frameCount=0;engine.timer=null;engine.waitKey=false;engine.waitTimeSwitch=false;engine.minimumWait=false;engine.atomStack=new Array;engine.alertStack=new Array;engine.st={};engine.st.vars={};engine.resetBlocks();engine.state="startScreen";engine.questionBoxUndef=-1;engine.questionBoxAnswer=engine.questionBoxUndef;engine.menuSetup()};engine.menuSetup=function(){items.setup(resources.items);items.menuUpdate();engine.mapMenu=new menu({items:items.menu,status:{action:function(){engine.mapMenu.wait=true;actions.showStatus("hero");engine.atomStack.push([function(){engine.mapMenu.wait=false},null])},index:1},test:new menu({test2:new menu({yes:{action:["goWait",function(){actions.showText("this is a yes!")},"stopWait","exit"],index:0,icon:"icon1"},no:{action:[function(){actions.showText("this is a no!")},"exit"],index:1,icon:"icon0"}},0),yes1:{action:[function(){actions.showText("this is a yes1!")},"exit"],index:1},no1:{action:[function(){actions.showText("this is a no1!")},"exit"],index:2}},2),config:new menu({showFPS:new menu({yes:{action:[function(){debug.FPS.show=true},"exit"],index:0},no:{action:[function(){debug.FPS.show=false},"exit"],index:1}},0),back:{action:"exit",index:2}},3),exit:{action:"exit",index:4}});menus.setParent(engine.mapMenu)};engine.playerFaceChar=function(){var count=chars.length;for(var i=0;i<count;i++){var thischar=chars[i];if(player!=thischar){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(thischar.mapx/32),cpy=Math.floor(thischar.mapy/32)+1;if(ppx-cpx==1&&cpy-ppy==0&&player.facing=="left")return thischar;if(ppx-cpx==-1&&cpy-ppy==0&&player.facing=="right")return thischar;if(ppx-cpx==0&&cpy-ppy==1&&player.facing=="down")return thischar;if(ppx-cpx==0&&cpy-ppy==-1&&player.facing=="up")return thischar}}return false};engine.updateChars=function(){var count=chars.length;for(var i=0;i<count;i++){var thischar=chars[i];thischar.update()}};engine.testWaitForKey=function(){if(HID.inputs["accept"].active){engine.waitKey=false;HID.inputs["accept"].active=false;engine.minimumWait=false}else if(HID.inputs["cancel"].active){engine.waitKey=false;HID.inputs["cancel"].active=false;engine.minimumWait=false}};engine.waitForKey=function(state){engine.waitKey=state;engine.minimumWait=false;setTimeout(function(){engine.minimumWait=true},300)};engine.waitTime=function(time){engine.waitTimeSwitch=true;engine.minimumWait=false;setTimeout(function(){engine.waitTimeSwitch=false},time)};engine.dirKeyActive=function(){if(HID.inputs["up"].active)return"up";else if(HID.inputs["down"].active)return"down";else if(HID.inputs["left"].active)return"left";else if(HID.inputs["right"].active)return"right";else return false};engine.loop=function(){try{if(!this.paused){HID.processGamepad();if(!engine.waitKey&&!engine.waitTimeSwitch){if(menus.isAnyMenuEnabled()){menus.updateMenuEnabled();engine.runatomStack()}else{if(engine.state=="map"){engine.updateChars()}else if(engine.state=="startScreen"){title.startScreen()}else if(engine.state=="battle"){battle.update()}engine.alertupdate();engine.runatomStack()}}else if(this.minimumWait){this.testWaitForKey()}}HID.clearInputs();engine.timer=setTimeout("engine.loop()",1e3/46)}catch(err){alert("engine loop error: "+err)}};engine.runatomStack=function(){if(engine.atomStack.length>0){while(engine.atomStack.length>0){eventToRun=engine.atomStack.shift();if(eventToRun[0]=="block"){break}else{eventToRun[0](eventToRun[1],eventToRun[2])}}}};evalCondition=function(param){var value=eval(param[0]);return value};eventInChar=function(char,evType,position){if(char["chara"]["actions"]["type"][0]==evType[0]&&char["chara"]["actions"]["type"][1]==evType[1]){char.charwasfacingfirst=char.facing;char.waits=16;var newfacing=player.charaFacingTo(char);if(newfacing){char.facing=newfacing}char.stopped=true;engine.resetBlocks();var aNmb,action,actionAndParam;for(aNmb=0;aNmb<char["chara"]["actions"]["list"].length;aNmb++){actionAndParam=char["chara"]["actions"]["list"][aNmb];translateActions(actionAndParam[0],actionAndParam[1],position,char)}engine.atomStack.push([function(){char.stopped=false;char.facing=char.charwasfacingfirst},""]);return true}else{return false}};player.charaFacingTo=function(chara){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(chara.mapx/32),cpy=Math.floor(chara.mapy/32)+1;var resx=cpx-ppx;var resy=cpy-ppy;if(resx==0&&resy<0)return"down";else if(resx==0&&resy>0)return"up";else if(resx<0&&resy==0)return"right";else return"left";console.log("error facing!");return false};player.facingPosition=function(){var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;return engine.facingPosition(player,px,py)};eventInMap=function(level,event,evType,position){engine.resetBlocks();if(level["eventsType"][event.toString()][0]==evType[0]&&level["eventsType"][event.toString()][1]==evType[1]){var aNmb,action,actionAndParam;for(aNmb=0;aNmb<level["eventsActions"][event.toString()].length;aNmb++){actionAndParam=level["eventsActions"][event.toString()][aNmb];translateActions(actionAndParam[0],actionAndParam[1],position)}}};engine.addItem=function(param){for(var i=0;i<param.length;i++){items.addItem(param[i])}};engine.battle=function(param){battle.start(param)};engine.changeState=function(param){engine.state=param[0]};engine.teleport=function(param){engine.state="map";engine.currentLevel=resources["levels"][param[2]];player.mapx=parseInt(param[0],10)*32;player.mapy=(parseInt(param[1],10)-1)*32;player.steps=0;HID.cleanInputs();HID.clearInputs();chars=new charalist;chars.push(player);engine.waitTime(100)};engine.changeTile=function(param){if(param[6]==null||param[6]=="this"){var levelToChange=engine.currentLevel}else{var levelToChange=resources["levels"][param[6]]}if(param[2]!=-1){levelToChange["Level"]["colision"][param[4]][param[5]]=param[2]}if(param[3]!=-1){levelToChange["Level"]["events"][param[4]][param[5]]=param[3]}levelToChange["Level"][param[1]][param[4]][param[5]]=param[0]};engine.evalNum=function(number){var value=number.slice(0);if(isNaN(value)){if(value.indexOf("var:")==0){return engine.st.vars[value.split("var:")[1]]}else if(value.indexOf("ans:")==0){if(value.split("ans:")[1]=="num"){return engine.questionBoxAnswer}else{return engine.questionBoxAnswerStr}}else if(value.indexOf("lastbattle:")==0){return battle.lastresult}else if(value.indexOf("hero:")==0){if(value.split("hero:")[1]=="face"){return player.facing}else if(value.split("hero:")[1]=="x"){return Math.floor(player.mapx/32)}else{return Math.floor(player.mapy/32)+1}}else{return value}}else{return+value}};engine.IF=function(param,blockId){if(engine.testVar(param)){var removeActions=false;for(var i=0;i<engine.atomStack.length;i++){if(engine.atomStack[i][0]==engine.ELSE&&engine.atomStack[i][2]==blockId){removeActions=true}if(engine.atomStack[i][0]==engine.END&&engine.atomStack[i][2]==blockId){return}if(removeActions){engine.atomStack.splice(i,1);i--}}}else{var actToRun=[0,0,0];while(engine.atomStack.length>0&&actToRun[0]!=engine.END&&actToRun[0]!=engine.ELSE||actToRun[2]!=blockId){actToRun=engine.atomStack.shift()}}};engine.END=function(){};engine.ELSE=function(){};engine.setVar=function(param){engine.st.vars[param[0]]=engine.evalNum(param[1])};engine.varPlusOne=function(param){if(isNaN(engine.st.vars[param[0]])){engine.st.vars[param[0]]=0}engine.st.vars[param[0]]++};engine.testVar=function(param){var var1=engine.evalNum(param[0]);if(var1=="true"){return true}else if(var1=="false"){return false}var operator=param[1];var var2=engine.evalNum(param[2]);var test={">":function(a,b){return a>b},bigger:function(a,b){return a>b},"<":function(a,b){return a<b},smaller:function(a,b){return a<b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},"==":function(a,b){return a==b},equal:function(a,b){return a==b},"=":function(a,b){return a==b}};return test[operator](var1,var2)};engine.showPicture=function(param){var picture={};picture["image"]=param[0];picture["position"]=[param[1],param[2]];screen.pictureStack.push(picture)};engine.stopPicture=function(param){screen.clearPicture()};engine.charAutoDelete=function(param,charatodel){var k=-2;for(var i=0;i<chars.length;i++){if(chars[i]==charatodel){k=i;break}}if(chars[k]!=engine.player){chars.splice(k,1)}};engine.questionBox=function(param){var answers={};engine.questionBoxAnswer=engine.questionBoxUndef;if(!(typeof engine.questionBoxMenu==="undefined")){engine.questionBoxMenu.mdelete()}for(var i=0;i<param.length;i++){(function(i){answers[param[i]]={action:[function(){engine.questionBoxAnswer=i;engine.questionBoxAnswerStr=param[i]},"exit"],index:i}})(i)}engine.questionBoxMenu=new menu(answers,undefined,true);menus.setParent(engine.questionBoxMenu);menus.setAllDrawables();engine.questionBoxMenu.activate()};engine.proceedBattleTurn=function(param){battle.waitherodecision=false};engine.alert=function(param){var textalert=actions.preText(param[0]);var textlife=60;for(var i=0;i<engine.alertStack.length;i++){if(engine.alertStack[i][0]==textalert){engine.alertStack[i][1]+=textlife;return}}engine.alertStack.push([textalert,textlife])};engine.alertupdate=function(){if(engine.alertStack.length>0){for(var i=0;i<engine.alertStack.length;i++){engine.alertStack[i][1]--}engine.alertStack.sort(function(a,b){return a[1]-b[1]});if(engine.alertStack[0][1]<=0){engine.alertStack.pop()}}};translateActions=function(action,param,position,charsender){actions[action](param,position,charsender)};engine.update=function(frameCount){engine.frameCount=frameCount};</script>

<script>
var actions={};lastBlock=function(){var value=0;var bstk=actions.blockStack.slice(0);if(bstk.length>1){value=bstk[bstk.length-1]}else if(bstk.length==1){value=bstk[0]}return value};actions.charAutoDelete=function(param,position,charatodel){var params=param.split(";");engine.atomStack.push([engine.charAutoDelete,params,charatodel])};actions.questionBox=function(param,position){var params=param.split(";");engine.questionBoxAnswer=engine.questionBoxUndef;engine.atomStack.push([engine.questionBox,params]);engine.atomStack.push(["block",null]);engine.atomStack.push(["block",null])};actions.stopPicture=function(param,position){engine.atomStack.push([engine.stopPicture,""])};actions.showPicture=function(param,position){var params=param.split(";");engine.atomStack.push([engine.showPicture,params])};actions.changeState=function(param,position){var params=param.split(";");engine.atomStack.push([engine.changeState,params])};actions.IF=function(param,position){var params=param.split(";");actions.blockCounter++;actions.blockStack.push(actions.blockCounter.valueOf());engine.atomStack.push([engine.IF,params,lastBlock()])};actions.ELSE=function(param,position){engine.atomStack.push([engine.ELSE,"",lastBlock()])};actions.END=function(param,position){engine.atomStack.push([engine.END,"",lastBlock()]);var popped=actions.blockStack.pop()};actions.preText=function(text){var pretexted=text.slice(0);return text.slice(0).replace(/(var:)([a-zA-Z0-9]+)/g,function(varname){return engine.evalNum(varname)})};actions.showStatus=function(param,position){var params=param.split(";");var herotoshow=battle.heroes[params[0]];engine.atomStack.push([function(herotosh){battle.herotoshowstatus=herotosh},herotoshow]);engine.atomStack.push([engine.waitForKey,true]);engine.atomStack.push(["block",null]);engine.atomStack.push([function(){battle.herotoshowstatus=false;engine.waitTime(400)},""])};actions.showText=function(param,position){text=actions.preText(param);engine.atomStack.push([printer.showText,text]);var linesTotal=printer.textLines(text);var lineNumber;for(lineNumber=0;lineNumber<linesTotal;lineNumber+=2){engine.atomStack.push([engine.waitForKey,true]);engine.atomStack.push(["block",null]);engine.atomStack.push([function(){printer.nextLine();engine.waitTime(400)},""])}};actions.teleport=function(param,position){var params=param.split(";");engine.atomStack.push([function(){screen.paused=true},""]);engine.atomStack.push([engine.teleport,params]);engine.atomStack.push([function(){screen.paused=false},""])};actions.changeTile=function(param,position){var colisionDict={keep:-1,noColision:0,collidable:1};var params3Value;var params=param.split(";");var aTileType=params[0];var aLayer=params[1];var aColision=colisionDict[params[2]];if(params[3]=="keep"){params3Value=-1}else if(params[3]=="remove"){params3Value=0}else{params3Value=parseInt(params[3],10)}var aEvent=params3Value;var aPositionX;var aPositionY;var aLevel;if(params[4]=="current"){aPositionY=parseInt(position[0],10);aPositionX=position[1];aLevel=null}else{aPositionX=params[4];aPositionY=params[5];aLevel=params[6]}engine.atomStack.push([engine.changeTile,[aTileType,aLayer,aColision,aEvent,aPositionY,aPositionX,aLevel]])};actions.fadeIn=function(param,position){var params=param.split(";");engine.atomStack.push([screen.effects.fadeIn,params]);for(var i=0;i<8;i++){engine.atomStack.push(["block",null])}};actions.fadeOut=function(param,position){var params=param.split(";");engine.atomStack.push([screen.effects.fadeOut,params]);for(var i=0;i<8;i++){engine.atomStack.push(["block",null])}};actions.setVar=function(param,position){var params=param.split(";");engine.atomStack.push([engine.setVar,params])};actions.varPlusOne=function(param,position){var params=param.split(";");engine.atomStack.push([engine.varPlusOne,params])};actions.testVar=function(param,position){var params=param.split(";");engine.atomStack.push([engine.testVar,params])};actions.noEffect=function(param,position){engine.atomStack.push([screen.effects.noEffect,""])};actions.battle=function(param,position){var params=param.split(";");actions.fadeOut("tension1;keepEffect");dist.setup(screen.canvas,"bgimg1",1);actions.changeState("battle");engine.atomStack.push([engine.battle,params])};actions.addItem=function(param,position){var params=param.split(";");engine.atomStack.push([engine.addItem,params])};actions.proceedBattleTurn=function(param,position){battle.herodecision="";engine.questionBoxAnswer=engine.questionBoxUndef;engine.atomStack.push([engine.proceedBattleTurn,[""]])};actions.alert=function(param,position){var params=param.split(";");engine.atomStack.push([engine.alert,params])};actions.rain=function(param,position){var params=param.split(";");if(params[0]=="start"){engine.atomStack.push([function(){screen.rains.startRain()},[""]])}else{engine.atomStack.push([function(){screen.rains.stopRain()},[""]])}};</script>

<script>
var camera={};camera.x=0;camera.y=0;camera.finex=0;camera.finey=0;camera.setupMap=function(_worldLevel,_engine){this.maxWorldWidth=_worldLevel["Level"]["layer1"][0].length;this.maxWorldHeight=_worldLevel["Level"]["layer1"].length};camera.setupCanvas=function(_canvas){this.yerror=1-screen.GHEIGHT/32%2;this.xerror=1-screen.GWIDTH/32%2;this.width=Math.floor(screen.GWIDTH/32)+1;this.height=Math.floor(screen.GHEIGHT/32)+1;this.halfWidth=Math.floor(this.width/2);this.halfHeight=Math.floor(this.height/2)};camera.panToChara=function(chara){charatilex=Math.floor(chara.mapx/32);charatiley=Math.floor(chara.mapy/32)+1;if(charatilex>this.halfWidth&&charatilex<this.maxWorldWidth-this.halfWidth){this.x=charatilex;this.finex=chara.mapx%32}else{if(charatilex==this.halfWidth){this.x=this.halfWidth;this.finex=chara.mapx%32}else if(charatilex<this.halfWidth){this.x=this.halfWidth;this.finex=0}else if(charatilex==this.maxWorldWidth-this.halfWidth-this.xerror){this.x=this.maxWorldWidth-this.halfWidth-this.xerror;this.finex=chara.mapx%32}else{this.x=this.maxWorldWidth-this.halfWidth-this.xerror;this.finex=30}}if(charatiley>this.halfHeight&&charatiley<this.maxWorldHeight-this.halfHeight){this.y=charatiley;this.finey=chara.mapy%32}else{if(charatiley==this.halfHeight){this.y=this.halfHeight;this.finey=chara.mapy%32}else if(charatiley<this.halfHeight){this.y=this.halfHeight}else if(charatiley==this.maxWorldHeight-this.halfHeight-this.yerror){this.y=this.maxWorldHeight-this.halfHeight-this.yerror;this.finey=chara.mapy%32}else{this.y=this.maxWorldHeight-this.halfHeight-this.yerror}}this.x-=this.halfWidth;this.y-=this.halfHeight};camera.drawMapLayer=function(_worldLevel,_zIndex){var targetFrame=Math.floor(screen.frameCount/8)%4;var vx=0,vy=0,currentTile,tileNumber;var screenx=0,screeny=0;this.panToChara(player);initX=Math.max(0,this.x);initY=Math.max(0,this.y);EndX=Math.min(this.maxWorldWidth,this.x+this.width);EndY=Math.min(this.maxWorldHeight,this.y+this.height);for(vx=initX,screenx=0;vx<EndX;vx++,screenx++){for(vy=initY,screeny=0;vy<EndY;vy++,screeny++){tileNumber=_worldLevel.Level[_zIndex][vy][vx];currentTile=_worldLevel.Level.tiles[tileNumber];if(_worldLevel.Level.tilesAnimated[tileNumber.toString()]){currentTile=_worldLevel.Level.tilesAnimated[tileNumber.toString()][targetFrame]}if(!currentTile)continue;screen.drawTile(resources.tileset,currentTile,[32*screenx-this.finex,32*screeny-this.finey])}}};camera.drawChar=function(chara){if(chara.steps)charaAnimation=chara["charaset"]["walking"][chara.facing];else charaAnimation=chara["charaset"]["standing"][chara.facing];var targetFrame=Math.floor(screen.frameCount/4)%charaAnimation.length;var screenx=0,screeny=0;screenx=chara.mapx-(this.x*32+this.finex);screeny=chara.mapy-(this.y*32+this.finey);screen.drawChara(resources.charasetimg,charaAnimation,targetFrame,[screenx,screeny])};printBox={};printBox.show=function(){screen.printBox.targetFrame=0;screen.printBox.anim="fadeIn"};printBox.isShown=function(){if(screen.printBox.anim=="box"){return true}else{return false}};printBox.close=function(){screen.printBox.targetFrame=screen.printBox.frameMax;screen.printBox.anim="fadeOut"};var screen={};screen.paused=false;screen.WIDTH=416;screen.HEIGHT=704;screen.GWIDTH=416;screen.GHEIGHT=416;screen.GSTARTX=0;screen.GSTARTY=0;screen.RATIO=null;screen.currentWidth=null;screen.currentHeight=null;screen.canvas=null;screen.ctx=null;screen.frameCount=0;screen.timer=null;screen.engine=null;screen.mobile=false;screen.setEngine=function(engine){this.engine=engine};screen.drawChara=function(charaset,animation,frameNumber,position){if(position[0]<this.GSTARTX-32||position[0]>this.GWIDTH+32||position[1]<this.GSTARTY-64||position[1]>this.GHEIGHT+64){return}screen.ctx.drawImage(charaset,32*animation[frameNumber][0],64*animation[frameNumber][1],32,64,this.GSTARTX+position[0],this.GSTARTY+position[1],32,64)};screen.drawText=function(text,posx,posy){screen.ctx.fillStyle="#221100";screen.ctx.fillText(text,screen.GSTARTX+posx,screen.GSTARTY+posy);screen.ctx.fillStyle="#FFFFFF";screen.ctx.fillText(text,screen.GSTARTX+posx-2,screen.GSTARTY+posy-2)};screen.drawTile=function(tileset,tile,position){screen.ctx.drawImage(tileset,32*tile[0],32*tile[1],32,32,this.GSTARTX+position[0],this.GSTARTY+position[1],32,32)};screen.drawImage=function(image,position){screen.ctx.drawImage(image,this.GSTARTX+position[0],this.GSTARTY+position[1])};screen.drawFace=function(faceset,tile,position,multiplix){multiplix=typeof multiplix==="undefined"?2:multiplix;screen.ctx.drawImage(faceset,64*tile[0],64*tile[1],64,64,this.GSTARTX+position[0],this.GSTARTY+position[1],64*multiplix,64*multiplix)};screen.flashMonster=function(monster,color){monster.flashcolor=color;monster.flash=10};screen.shakeMonster=function(monster){monster.shake=10};screen.drawMonster=function(monster,position){var tempalpha=screen.ctx.globalAlpha;var modx=0;var mody=0;if(monster.dead){return}if(monster.selected&&monster.flash==0){screen.flashMonster(monster,"#111111")}if(monster.shake>0){monster.shake--;modx=Math.floor(8*Math.random())*4;mody=Math.floor(8*Math.random())*4}if(monster.flash>0){screen.ctx.drawImage(screen.flashColor(resources.monsterimg,monster.flashcolor),64*monster.monsterImg[0],64*monster.monsterImg[1],64,64,this.GSTARTX+position[0]+modx,this.GSTARTY+position[1]+mody,128,128);screen.ctx.globalAlpha=1*monster.flash/10;monster.flash--}screen.ctx.drawImage(resources.monsterimg,64*monster.monsterImg[0],64*monster.monsterImg[1],64,64,this.GSTARTX+position[0]+modx,this.GSTARTY+position[1]+mody,128,128);screen.ctx.globalAlpha=tempalpha;screen.ctx.fillStyle="#ffffff";screen.drawText("hp:"+monster.hp,position[0],position[1]-32);screen.drawText(" /"+monster.hpmax,position[0],position[1]-8)};screen.flashColor=function(fg,color){var buffer=document.createElement("canvas");buffer.width=fg.width;buffer.height=fg.height;var bx=buffer.getContext("2d");bx.fillStyle=color;bx.fillRect(0,0,buffer.width,buffer.height);bx.globalCompositeOperation="destination-atop";bx.drawImage(fg,0,0);return buffer};screen.init=function(){window.addEventListener("resize",screen.resize,false);window.addEventListener("orientationchange",screen.resize,false);this.RATIO=this.WIDTH/this.HEIGHT;this.mobile=window.mobilecheck();this.currentWidth=this.WIDTH;this.currentHeight=this.HEIGHT;this.canvas=document.getElementsByTagName("canvas")[0];this.canvas.width=this.WIDTH;this.canvas.height=this.HEIGHT;this.ctx=this.canvas.getContext("2d");this.ctx.font="32px INFO56";this.ORIGINALGSTARTX=this.GSTARTX;this.ORIGINALGSTARTY=this.GSTARTY;this.resize();screen.HIDcsetup();this.pictureStack=new Array;this.ua=navigator.userAgent.toLowerCase();this.android=this.ua.indexOf("android")>-1?true:false;this.ios=this.ua.indexOf("iphone")>-1||this.ua.indexOf("ipad")>-1?true:false;window.addEventListener("load",screen.init,false);this.ctx.mozImageSmoothingEnabled=false;this.ctx.webkitImageSmoothingEnabled=false;this.ctx.imageSmoothingEnabled=false;(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}})();screen.rains=new rain(this.ctx,this.GWIDTH,this.GHEIGHT,screen);screen.requestAnimationFrame=window.requestAnimationFrame;window.addEventListener("click",function(){if(engine.state=="startScreen"){var el=document.documentElement;var rfs=el.requestFullScreen||el.webkitRequestFullscreen||el.mozRequestFullScreen;rfs.call(el);window.setTimeout(function(){screen.resize();console.log("should had resized!")},1500)}})};screen.resize=function(){screen.ctx.mozImageSmoothingEnabled=false;screen.ctx.webkitImageSmoothingEnabled=false;screen.ctx.imageSmoothingEnabled=false;if(screen.mobile){this.currentHeight=window.innerHeight;this.currentWidth=this.currentHeight*this.RATIO}else{this.GHEIGHT=256;this.currentHeight=window.innerHeight*this.HEIGHT/this.GHEIGHT;this.currentWidth=this.currentHeight*this.RATIO}if(this.android||this.ios){document.body.style.height=window.innerHeight+50+"px"}screen.canvas.style.width=this.currentWidth+"px";screen.canvas.style.height=this.currentHeight+"px";window.setTimeout(function(){window.scrollTo(0,1)},1)};screen.drawButton=function(pHIDItem){if(pHIDItem.active){this.ctx.fillStyle="#ff9900";this.ctx.fillRect(pHIDItem.mapX,pHIDItem.mapY+this.GHEIGHT,96,96)}};screen.drawHID=function(){screen.ctx.drawImage(screen.HIDButtons,0,screen.GHEIGHT);var HIDItem;for(var tag in HID.inputs){HIDItem=HID.inputs[tag];screen.drawButton(HIDItem)}};screen.HIDcsetup=function(){screen.HIDButtons=document.createElement("canvas");screen.HIDButtons.width=screen.WIDTH;screen.HIDButtons.height=screen.HEIGHT-screen.GHEIGHT;var hx=screen.HIDButtons.getContext("2d");hx.fillStyle="#221F1B";hx.fillRect(0,0,screen.HIDButtons.width,screen.HIDButtons.height);var HIDItem;for(var tag in HID.inputs){HIDItem=HID.inputs[tag];hx.fillStyle=HIDItem.color;hx.fillRect(HIDItem.mapX,HIDItem.mapY,96,96);hx.fillStyle="#FFFFFF";hx.fillText(HIDItem.letter,HIDItem.mapX+32,HIDItem.mapY+64)}};screen.clearAll=function(){this.ctx.fillRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)};screen.printBox={setup:function(imgPrintSet){this.Width=screen.GWIDTH;this.Height=96;this.X=0;this.Y=screen.GHEIGHT-this.Height;this.imgPrintSet=imgPrintSet;this.aSizex=[32,64,128,this.Width,this.Width];this.aSizey=[32,32,48,48,this.Height];this.anim="none";this.frameMax=this.aSizex.length-1;this.targetFrame=this.frameMax},printSet:{background:{x:0,y:0,sizex:64,sizey:64},topLeftBox:{x:64,y:0,sizex:16,sizey:16},topRightBox:{x:112,y:0,sizex:16,sizey:16},bottomLeftBox:{x:64,y:48,sizex:16,sizey:16},bottomRightBox:{x:112,y:48,sizex:16,sizey:16},LeftBox:{x:64,y:16,sizex:16,sizey:32},RightBox:{x:112,y:16,sizex:16,sizey:32},TopBox:{x:80,y:0,sizex:32,sizey:16},BottomBox:{x:80,y:48,sizex:32,sizey:16},acceptUp:{x:0,y:64,sizex:16,sizey:16},acceptDown:{x:16,y:64,sizex:16,sizey:16},icon0:{x:0,y:96,sizex:64,sizey:64},icon1:{x:64,y:96,sizex:64,sizey:64}},drawButtonAccept:function(){var frame=Math.floor(screen.frameCount/4)%2;if(frame==0){var accept=this.printSet.acceptUp}else{var accept=this.printSet.acceptDown}screen.ctx.drawImage(imgPrintSet,accept["x"],accept["y"],accept["sizex"],accept["sizey"],screen.GSTARTX+screen.GWIDTH-32,screen.GSTARTY+screen.GHEIGHT-32,accept["sizex"],accept["sizey"])},drawElement:function(element,x,y,sizex,sizey,imgPrintSet,select){select=typeof select==="undefined"?0:select;screen.ctx.drawImage(imgPrintSet,element["x"]+select*64,element["y"],element["sizex"],element["sizey"],screen.GSTARTX+x,screen.GSTARTY+y,sizex,sizey)},drawBoxAnimation:function(){if(this.anim=="none"){return}else if(this.anim=="box"){this.targetFrame=this.frameMax}else if(this.anim=="fadeIn"){if(this.targetFrame<this.frameMax)this.targetFrame++;else{this.anim="box";this.targetFrame=this.frameMax}}else if(this.anim=="fadeOut"){if(this.targetFrame>0)this.targetFrame--;else{this.anim="none";return}}screen.printBox.drawBox(Math.floor(screen.printBox.X+screen.printBox.Width/2-this.aSizex[this.targetFrame]/2),Math.floor(screen.printBox.Y+screen.printBox.Height/2-this.aSizey[this.targetFrame]/2),this.aSizex[this.targetFrame],this.aSizey[this.targetFrame]);if(this.anim=="box"){this.drawButtonAccept()}},drawBox:function(x,y,sizex,sizey,select){select=typeof select==="undefined"?0:select;imgPrintSet=screen.printBox.imgPrintSet;s=screen["printBox"]["printSet"];if(select==0){screen.printBox.drawElement(s["background"],x,y,sizex,sizey,imgPrintSet)}screen.printBox.drawElement(s["topLeftBox"],x,y,s["topLeftBox"]["sizex"],s["topLeftBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["TopBox"],x+s["topLeftBox"]["sizex"],y,sizex-s["topLeftBox"]["sizex"]-s["topRightBox"]["sizex"],s["TopBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["topRightBox"],x+sizex-s["topRightBox"]["sizex"],y,s["topRightBox"]["sizex"],s["topRightBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["LeftBox"],x,y+s["topLeftBox"]["sizey"],s["LeftBox"]["sizex"],sizey-s["topLeftBox"]["sizey"]-s["bottomLeftBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["RightBox"],x+sizex-s["topRightBox"]["sizex"],y+s["topRightBox"]["sizey"],s["RightBox"]["sizex"],sizey-s["topRightBox"]["sizey"]-s["bottomRightBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["bottomLeftBox"],x,y+sizey-s["bottomLeftBox"]["sizey"],s["bottomLeftBox"]["sizex"],s["bottomLeftBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["BottomBox"],x+s["bottomLeftBox"]["sizex"],y+sizey-s["bottomRightBox"]["sizey"],sizex-s["bottomLeftBox"]["sizex"]-s["bottomRightBox"]["sizex"],s["BottomBox"]["sizey"],imgPrintSet,select);screen.printBox.drawElement(s["bottomRightBox"],x+sizex-s["bottomRightBox"]["sizex"],y+sizey-s["bottomRightBox"]["sizey"],s["bottomRightBox"]["sizex"],s["bottomRightBox"]["sizey"],imgPrintSet,select)}};screen.effectPixelize2=function(pixelation){var imageData=this.ctx.getImageData(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT);var data=imageData.data;for(var y=0;y<this.GHEIGHT;y+=pixelation){for(var x=0;x<this.GWIDTH;x+=pixelation){var red=data[(this.GWIDTH*y+x)*4];var green=data[(this.GWIDTH*y+x)*4+1];var blue=data[(this.GWIDTH*y+x)*4+2];for(var n=0;n<pixelation;n++){for(var m=0;m<pixelation;m++){if(x+m<this.GWIDTH){data[(this.GWIDTH*(y+n)+(x+m))*4]=red;data[(this.GWIDTH*(y+n)+(x+m))*4+1]=green;data[(this.GWIDTH*(y+n)+(x+m))*4+2]=blue}}}}}this.ctx.putImageData(imageData,0,0)};screen.effectPixelize=function(pixelation){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT,this.GSTARTX,this.GSTARTY,pixelation,pixelation);this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,pixelation,pixelation,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)};screen.effectTension1=function(intensity){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX-this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT);this.ctx.drawImage(this.canvas,this.GSTARTX+this.GWIDTH/2,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX+this.GWIDTH/2+this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT);this.ctx.fillStyle="#000000";this.ctx.fillRect(Math.floor(this.GSTARTX+this.GWIDTH/2-this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH*intensity/128),this.GHEIGHT)};screen.effectColor=function(opacity,color){this.ctx.save();this.ctx.fillStyle=color;this.ctx.globalAlpha=opacity;this.ctx.fillRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT);this.ctx.restore()};screen.shakeEffect=function(){if(this.shaking){if(this.shakes>0){this.shakes--;if(this.shaking=="h"){this.GSTARTX=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTX}else{this.GSTARTY=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTY}}else if(this.shakes==0){this.shakes--;this.GSTARTX=this.ORIGINALGSTARTX;this.GSTARTY=this.ORIGINALGSTARTY;this.shaking=false}}};screen.shakeScreen=function(horv){horv=typeof horv==="undefined"?"h":horv;this.shakes=typeof this.shakes==="undefined"?0:this.shakes;this.shakes+=16;if(horv=="h"){this.shaking="h"}else{this.shaking="v"}};screen.effects={selected:null,startFrame:0,endFrame:0,intensity:[8,16,24,32,48,64,128],keepAfter:false,fadeIn:function(params){var changeEffect=params[0];var shouldKeepAfter=params[1];screen.effects.startFrame=screen.frameCount;screen.effects.endFrame=screen.effects.intensity.length;screen.effects.selected=changeEffect;if(shouldKeepAfter=="keepEffect")screen.effects.keepAfter=true;else screen.effects.keepAfter=false},fadeOut:function(params){var changeEffect=params[0];var shouldKeepAfter=params[1];screen.effects.startFrame=screen.frameCount;screen.effects.endFrame=screen.effects.intensity.length;screen.effects.selected=changeEffect;if(shouldKeepAfter=="keepEffect"){screen.effects.keepAfter=true}else screen.effects.keepAfter=false},noEffect:function(){screen.effects.selected=null}};screen.drawEffects=function(){if(screen.effects.selected==null){return}if(screen.effects.selected=="pixelizeFadeIn"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectPixelize(screen.effects.intensity[frameToDraw])}if(screen.effects.selected=="pixelizeFadeOut"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectPixelize(screen.effects.intensity[frameToDraw])}if(screen.effects.selected=="blackFadeOut"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#000000")}if(screen.effects.selected=="blackFadeIn"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#000000")}if(screen.effects.selected=="whiteFadeOut"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#FFFFFF")}if(screen.effects.selected=="whiteFadeIn"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#FFFFFF")}if(screen.effects.selected=="tension1"){var frameToDraw=screen.frameCount-screen.effects.startFrame-1;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectTension1(screen.effects.intensity[frameToDraw])}};function compareChars(a,b){if(a.mapy==b.mapy){return a.mapx<b.mapx?-1:a.mapx>b.mapx?1:0}else{return a.mapy<b.mapy?-1:1}}camera.drawChars=function(){chars.sort(compareChars);var count=chars.length;for(var i=0;i<count;i++){var item=chars[i];camera.drawChar(item)}};screen.drawMonsters=function(){for(var i=0;i<battle.monster.length;i++){screen.drawMonster(battle.monster[i],[Math.floor((i+1)*screen.GWIDTH/(battle.monster.length+1)-64),Math.floor(screen.GHEIGHT/3)])}};screen.drawMenu=function(menu){var maxItems=menu.itemsLength;var maxItemStringLength=menu.maxItemStringSize();screen.printBox.drawBox(menu["drawx"],menu["drawy"],menu["width"],menu["height"]);for(var i=0;i<maxItems;i+=1){if(menu.items[Object.keys(menu.items)[i]].selected){if(menu.wait){screen.printBox.drawBox(menu["drawx"]+8,menu["drawy"]+8+32*i,menu["width"]-16,32,1)}else{screen.printBox.drawBox(menu["drawx"]+8,menu["drawy"]+8+32*i,menu["width"]-16,32,1+Math.floor(screen.frameCount/4)%2)}if(typeof menu.items[Object.keys(menu.items)[i]].icon!=="undefined"){var imgPrintSet=screen.printBox.imgPrintSet;var s=screen["printBox"]["printSet"];var icon=s[menu.items[Object.keys(menu.items)[i]].icon];screen.printBox.drawBox(menu["drawx"]+menu["width"],menu["drawy"],icon.sizex+16,icon.sizey+16);screen.printBox.drawElement(icon,menu["drawx"]+menu["width"]+8,menu["drawy"]+8,icon.sizex,icon.sizey,imgPrintSet)}}screen.drawText(Object.keys(menu.items)[i],+menu["drawx"]+16,menu["drawy"]+menu.items[Object.keys(menu.items)[i]].itemy)}};screen.drawStatus=function(heroch){var hero=heroch;var statw=screen.GWIDTH-32-96;var stath=screen.GHEIGHT-16;var statx=16+96+8;var staty=8;screen.printBox.drawBox(statx,staty,statw,stath);screen.printBox.drawBox(statx,staty,statw,stath,0);var keys=["name","st","dx","iq","level","xp"];for(var i=0;i<keys.length;i++){var atr=keys[i];var atrval=heroch[atr];if(atr!="name"){screen.drawText(atr+": "+atrval,statx+16,staty+32*(1+i))}else{screen.drawText(atrval,statx+16,staty+32*(1+i))}}screen.drawText("xp to next level: "+heroch.xpnextlevel,statx+16,staty+32*(1+i));screen.drawText("hp: "+heroch.hp+"/"+heroch.hpmax,statx+144,staty+32*i);screen.drawFace(resources.faceset,heroch.face,[statx+144,staty+16]);screen.printBox.drawButtonAccept()};screen.showpicture=function(){if(screen.pictureStack.length>0){for(var i=0;i<screen.pictureStack.length;i+=1){screen.drawImage(resources.pictures[screen.pictureStack[i].image],screen.pictureStack[i].position)}}};screen.clearPicture=function(){for(var member in screen.pictureStack)delete screen.pictureStack[member];screen.pictureStack.length=0};screen.drawAlert=function(text,index){screen.drawText(text,128,index*32+32)};screen.drawAlerts=function(){for(var i=0;i<engine.alertStack.length;i++){screen.drawAlert(engine.alertStack[i][0],i)}};screen.loop=function(){try{screen.frameCount+=1;screen.clearAll();if(!screen.paused){engine.update(screen.frameCount);screen.shakeEffect();if(engine.state=="map"){camera.setupMap(engine.currentLevel);if(debug.showLayer.layer1)camera.drawMapLayer(engine.currentLevel,"layer1");if(debug.showLayer.layer2)camera.drawMapLayer(engine.currentLevel,"layer2");if(debug.showLayer.layer3)camera.drawChars();if(debug.showLayer.layer4)camera.drawMapLayer(engine.currentLevel,"layer4");screen.rains.DrawRain()}else if(engine.state=="startScreen"){}else if(engine.state=="battle"){dist.test(dist.efnumb[0]);screen.drawMonsters()}screen.showpicture();screen.drawEffects();screen.drawHID();for(var menuToDraw in menus.allMenus){if(menus.allMenus[menuToDraw].enabled){screen.drawMenu(menus.allMenus[menuToDraw])}}if(battle.herotoshowstatus){screen.drawStatus(battle.herotoshowstatus)}screen.printBox.drawBoxAnimation();screen.drawAlerts();printer.update()}debug.FPS.draw();screen.requestAnimationFrame.call(window,screen.loop)}catch(err){alert("screen loop error: "+err)}};debug={};debug.showLayer={layer1:true,layer2:true,layer3:true,layer4:true};debug.FPS={counter:0,FPS:0,show:false,draw:function(){this.counter+=1;if(this.show){screen.ctx.fillText(this.FPS.toString()+" fps",screen.GSTARTX+2,screen.GSTARTY+16)}},loop:function(){this.FPS=this.counter;this.counter=0;this.timer=setTimeout("debug.FPS.loop()",1e3)}};</script>

<script>
var HID={scale:1,bsz:96,offset:416,axeNotNull:.4,inputs:{up:{letter:"W",active:false,mapX:96,mapY:0,color:"#111111",gamepad:function(pad){return pad.axes[1]<-HID.axeNotNull}},left:{letter:"A",active:false,mapX:0,mapY:96,color:"#111111",gamepad:function(pad){return pad.axes[0]<-HID.axeNotNull}},down:{letter:"S",active:false,mapX:96,mapY:192,color:"#111111",gamepad:function(pad){return pad.axes[1]>HID.axeNotNull}},right:{letter:"D",active:false,mapX:192,mapY:96,color:"#111111",gamepad:function(pad){return pad.axes[0]>HID.axeNotNull}},accept:{letter:"I",active:false,mapX:304,mapY:32,color:"#127826",gamepad:function(pad){return pad.buttons[0].pressed}},cancel:{letter:"J",active:false,mapX:304,mapY:160,color:"#ed1c24",gamepad:function(pad){return pad.buttons[1].pressed}}},debugKeys:{resize:{letter:"0",toggle:function(){screen.resize()}},layer1:{letter:"1",toggle:function(){debug.showLayer.layer1=!debug.showLayer.layer1}},layer2:{letter:"2",toggle:function(){debug.showLayer.layer2=!debug.showLayer.layer2}},layer3:{letter:"3",toggle:function(){debug.showLayer.layer3=!debug.showLayer.layer3}},layer4:{letter:"4",toggle:function(){debug.showLayer.layer4=!debug.showLayer.layer4}}},processGamepad:function(){if(typeof HID.gamepads!="undefined"){for(var i=0;i<HID.gamepads.length;++i){var pad=HID.gamepads[i];for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];if(HIDItem.gamepad(pad)){HIDItem.active=true}else HIDItem.active=false}}}},clearInputs:function(){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];HIDItem.release=false}},cleanInputs:function(){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];HIDItem.active=false}},log:function(text){var tag=document.getElementById("log");tag.innerHTML=text},keyDown:function(e){var evtobj=window.event?event:e;var unicode=evtobj.charCode?evtobj.charCode:evtobj.keyCode;var actualkey=String.fromCharCode(unicode);for(var key in HID.inputs){var HIDItem=HID.inputs[key];if(actualkey==HIDItem.letter){HIDItem.active=true}}},keyUp:function(e){var evtobj=window.event?event:e;var unicode=evtobj.charCode?evtobj.charCode:evtobj.keyCode;var actualkey=String.fromCharCode(unicode);for(var key in HID.inputs){var HIDItem=HID.inputs[key];if(actualkey==HIDItem.letter){HIDItem.active=false}}for(var key in HID.debugKeys){var HIDItem=HID.debugKeys[key];if(actualkey==HIDItem.letter){HIDItem.toggle()}}},setupTouchZone:function(_screen){this.screen=_screen;this.touchzone=this.screen.canvas},setupKeyboardListeners:function(){document.onkeydown=HID.keyDown;document.onkeyup=HID.keyUp},handleTouchDown:function(evnt){evnt.preventDefault();HID.processTouches(event.touches,"down")},handleTouchMove:function(evnt){evnt.preventDefault();HID.processTouches(event.touches,"move")},handleTouchUp:function(evnt){evnt.preventDefault();HID.processTouches(event.touches,"up")},processTouches:function(touches,kind){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];var touched=false;var offsetTop=this.screen.canvas.offsetTop,offsetLeft=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var i=0;i<touches.length;i++){var position={x:(touches[i].pageX-offsetLeft)/scale,y:(touches[i].pageY-offsetTop)/scale};if(position.x>HIDItem.mapX&&position.y>this.offset+HIDItem.mapY){if(position.x<HIDItem.mapX+this.bsz&&position.y<this.offset+HIDItem.mapY+this.bsz){touched=true}}}if(touched){HIDItem.active=true;if(kind=="down"){HIDItem.release=true}}else{HIDItem.active=false}}for(var menuTag in menus.allMenus){var aMenu=menus.allMenus[menuTag];if(aMenu.enabled&&!aMenu.wait){var maxItems=aMenu.itemsLength;for(var menuItemTag in aMenu.items){var menuItem=aMenu.items[menuItemTag];var touched=false;var offsetTop=this.screen.canvas.offsetTop,offsetLeft=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var i=0;i<touches.length;i++){var position={x:(touches[i].pageX-offsetLeft)/scale,y:(touches[i].pageY-offsetTop)/scale};if(position.x>screen.GSTARTX+aMenu.drawx&&position.y>screen.GSTARTY+aMenu.drawy+menuItem.itemy-32){if(position.x<screen.GSTARTX+aMenu.drawx+aMenu.width&&position.y<screen.GSTARTY+aMenu.drawy+menuItem.itemy){touched=true}}}if(touched){if(kind=="down"&&menuItem.selected){HID.inputs["accept"].active=true;return}for(var z=0;z<maxItems;z+=1){aMenu.items[Object.keys(aMenu.items)[z]].selected=false}menuItem.selected=true;aMenu.selectedItem=menuItem}}}}},setupListeners:function(){window.addEventListener("touchstart",HID.handleTouchDown,false);window.addEventListener("touchmove",HID.handleTouchMove,false);window.addEventListener("touchend",HID.handleTouchUp,false);window.addEventListener("gamepadconnected",function(e){HID.gamepads=navigator.getGamepads();actions.alert("gamepad connected!")});window.addEventListener("gamepaddisconnected",function(e){HID.gamepads=[];HID.cleanInputs();HID.clearInputs();actions.alert("gamepad disconnected.")})},setup:function(screentosetup){this.setupTouchZone(screentosetup);this.setupListeners();this.setupKeyboardListeners()}};</script>

<script>
var printer={};printer.currentText=null;printer.dialogLines=null;printer.currentLine=0;printer.isShown=false;function wordWrap(str,width,brk,cut){brk=brk||"\n";width=width||75;cut=cut||false;if(!str){return str}var regex=".{1,"+width+"}(\\s|$)"+(cut?"|.{"+width+"}|.+$":"|\\S+?(\\s|$)");return str.match(RegExp(regex,"g")).join(brk)}printer.textLines=function(_text){var textResult=wordWrap(_text,31);var numberOfLines=textResult.split("\n").filter(Boolean).length;return numberOfLines};printer.showText=function(_text){printer.currentText=wordWrap(_text,31);printer.currentLine=0;printer.isShown=true;printer.dialogLines=printer.currentText.split("\n").filter(Boolean);printBox.show();printer.LineWords=[];if(printer.dialogLines.length-printer.currentLine<1){printer.wordIndexLine=[];printer.LineWords=null}else{if(printer.dialogLines.length-printer.currentLine<2){printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" "));printer.wordIndexLine=[0]}else{printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" "));printer.LineWords.push(printer.dialogLines[printer.currentLine+1].split(" "));printer.wordIndexLine=[0,0]}}printer.Line=["",""];printer.LineLine=0};printer.dismissText=function(){printer.currentText=null;printer.currentLine=0;printer.isShown=false;printer.dialogLines=null;printBox.close();printer.LineWords=[];printer.wordIndexLine=[];printer.Line=["",""];printer.LineLine=0};printer.nextLine=function(){printer.LineWords=[];printer.currentLine+=2;if(printer.currentLine>=printer.dialogLines.length){printer.dismissText();return}printer.LineWords=[];if(printer.dialogLines.length-printer.currentLine<1){printer.wordIndexLine=[];printer.LineWords=null}else{if(printer.dialogLines.length-printer.currentLine<2){printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" "));printer.wordIndexLine=[0]}else{printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" "));printer.LineWords.push(printer.dialogLines[printer.currentLine+1].split(" "));printer.wordIndexLine=[0,0]}}printer.Line=["",""];printer.LineLine=0};printer.update=function(){var lines=null,i=0,j=0,l=0,k=0;if(printer.currentText){if(printer.dialogLines.length){if(printBox.isShown()){if(Math.floor(screen.frameCount/4)%2){if(this.LineLine<printer.wordIndexLine.length&&printer.LineWords!=null){feedbackEng.play("word");if(printer.wordIndexLine[this.LineLine]<printer.LineWords[this.LineLine].length){printer.Line[this.LineLine]+=printer.LineWords[this.LineLine][printer.wordIndexLine[this.LineLine]]+" ";printer.wordIndexLine[this.LineLine]+=1}else{this.LineLine+=1}}}for(i=printer.currentLine,j=0;i<printer.dialogLines.length&&j<2;i+=1,j+=1){screen.drawText(printer.Line[i%2],screen.printBox.X+16,screen.printBox.Y+40+j*34)}}}}};</script>

<script>
var title={};title.setup=function(){title.startMenu=new menu({start:{action:[function(){actions.showText("let's play!");actions.fadeOut("blackFadeOut;keepEffect");actions.changeState("map")},function(){actions.stopPicture("")},function(){actions.fadeIn("blackFadeIn;doNotKeep")},"exit"],index:0},exit:{action:"exit",index:1}},undefined,true);menus.setParent(title.startMenu);title.startMenu.activate();actions.showPicture("title;0;0");setTimeout(function(){if(engine.state=="startScreen"){engine.showPicture(["keys0","160","8"]);engine.showPicture(["controllers","8",(screen.GHEIGHT-32).toString()])}},1e3);setTimeout(function(){if(engine.state=="startScreen"){engine.showPicture(["keys2","160","24"])}},4e3);setTimeout(function(){if(engine.state=="startScreen"){engine.stopPicture("");engine.showPicture(["title","0","0"]);engine.showPicture(["keys1","150","16"]);engine.showPicture(["controllers","8",(screen.GHEIGHT-32).toString()])}},1e4)};title.startScreen=function(){title.update()};title.update=function(){if(printer.isShown)return;if(player.steps==0){if(HID.inputs["cancel"].active){HID.inputs["cancel"].active=false;title.startMenu.activate()}}};</script>

<script>
var dist={};dist.setup=function(viewCanvas,backgroundImage,alpha){dist.alpha=alpha;dist.tickssy=0;dist.bfx={};dist.efnumb=[];dist.efnumb[0]=1;dist.bfx.effectsrom=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[120,0,4,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,1,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,2,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,3,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[255,0,3,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,3,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[255,0,1,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,1,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[0,0,3,0,2,0,128,0,0,2,0,0,0,0,0,0,0],[0,0,3,0,2,0,128,0,128,0,0,0,0,0,0,0,0],[0,1,3,0,4,0,64,0,0,1,0,0,0,0,0,2,0],[0,1,3,0,4,0,64,0,0,3,0,0,0,0,0,254,255],[0,4,1,0,8,0,64,128,0,0,254,255,0,0,1,0,0],[0,4,1,0,0,0,64,128,0,0,2,0,0,0,255,0,0],[88,2,3,0,0,0,0,0,0,1,0,0,0,0,0,3,0],[88,2,3,0,0,0,0,0,8,8,0,0,0,0,0,253,255],[0,2,3,0,0,0,0,0,0,2,0,0,0,0,0,255,255],[0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[240,0,3,0,0,0,0,0,224,2,0,0,0,0,0,254,255],[240,0,3,0,0,0,0,0,0,0,0,0,0,0,0,2,0],[240,0,1,0,4,0,128,1,0,0,254,255,156,255,1,0,0],[240,0,1,32,2,64,34,241,0,0,2,0,100,0,255,0,0],[0,1,4,0,2,0,64,2,0,1,2,0,0,0,1,2,0],[0,1,4,0,4,0,64,2,0,3,254,255,0,0,255,254,255],[0,0,1,128,0,0,8,1,0,0,0,0,0,0,0,0,0],[0,1,1,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,1,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,2,0,0,0,0,128,0,0,0,0],[244,1,1,0,2,0,250,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,10,0,0,0,0,80,0,0,0,0],[244,1,1,0,2,64,156,10,0,0,0,0,176,255,0,0,0],[240,0,3,0,2,0,8,2,0,0,0,0,0,0,0,1,0],[224,1,3,0,2,0,8,2,0,240,0,0,0,0,0,254,255],[240,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[180,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,128,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,64,0,0,0,0],[0,0,2,0,16,128,250,10,0,0,0,0,0,0,0,0,0],[224,1,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[240,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,224,0,0,16,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[224,1,3,0,2,0,4,2,0,1,0,0,0,0,0,2,0],[224,1,3,0,2,0,4,2,192,4,0,0,0,0,0,254,255],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,150,0,0,0,0],[0,1,3,0,4,0,150,2,0,0,0,0,106,255,0,0,0],[104,1,4,0,1,0,0,0,0,0,0,0,60,0,2,0,0],[104,1,4,0,1,96,84,0,0,0,0,0,196,255,2,0,0],[0,0,3,0,1,0,4,0,0,0,0,0,0,0,2,0,0],[240,0,4,0,1,0,0,0,0,0,0,0,90,0,2,0,0],[240,0,4,0,1,96,84,0,0,0,0,0,166,255,2,0,0],[254,1,3,0,2,0,0,0,0,0,0,0,128,0,0,0,0],[254,1,3,0,2,0,255,0,0,0,0,0,128,255,0,0,0]];dist.bfx.w=256;dist.bfx.h=240;dist.buffer=document.createElement("canvas");dist.buffer.width=dist.bfx.w;dist.buffer.height=dist.bfx.h;dist.bufferwidth=dist.buffer.width;dist.bufferheight=dist.buffer.height;dist.bctx=dist.buffer.getContext("2d");dist.bgimage=document.getElementById(backgroundImage);dist.bctx.drawImage(dist.bgimage,0,0,416,416,0,0,dist.bfx.w,dist.bfx.h);dist.bufferData=dist.bctx.getImageData(0,0,dist.bfx.w,dist.bfx.h);dist.bdata=dist.bufferData.data;dist.bctx.mozImageSmoothingEnabled=false;dist.bctx.webkitImageSmoothingEnabled=false;dist.bctx.imageSmoothingEnabled=false;dist.visible=viewCanvas;dist.fctx=dist.visible.getContext("2d");dist.fctx.mozImageSmoothingEnabled=false;dist.fctx.webkitImageSmoothingEnabled=false;dist.fctx.imageSmoothingEnabled=false;dist.bfx.getType=function(){return dist.bfx.effect[2]};dist.bfx.getDuration=function(){return dist.bfx.effect[0]+(dist.bfx.effect[1]<<8)};dist.bfx.getFrequency=function(){return dist.bfx.effect[3]+(dist.bfx.effect[4]<<8)};dist.bfx.getAmplitude=function(){return dist.bfx.effect[5]+(dist.bfx.effect[6]<<8)};dist.bfx.getCompression=function(){return dist.bfx.effect[8]+(dist.bfx.effect[9]<<8)};dist.bfx.getFrequencyAcceleration=function(){return dist.bfx.effect[10]+(dist.bfx.effect[11]<<8)};dist.bfx.getAmplitudeAcceleration=function(){return dist.bfx.effect[12]+(dist.bfx.effect[13]<<8)};dist.bfx.getSpeed=function(){return dist.bfx.effect[14]};dist.bfx.getCompressionAcceleration=function(){return dist.bfx.effect[15]+(dist.bfx.effect[16]<<8)};dist.Distorter=function(y,t,distortEffect,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed){var C1=(1/512).toFixed(6);var C2=(8*Math.PI/(1024*256)).toFixed(6);var C3=(Math.PI/60).toFixed(6);var amplitude=ampl+ampl_accel*t*2;var frequency=s_freq+s_freq_accel*t*2;var compression=compr+compr_accel*t*2;var S=Math.round(C1*amplitude*Math.sin((C2*frequency*y+C3*speed*t).toFixed(6)));if(distortEffect==1){return S}else if(distortEffect==2){return y%2==0?-S:S}else if(distortEffect==3){var L=Math.floor(y*(1+compression/256)+S)%256;if(L<0)L=256+L;if(L>255)L=256-L;return L}return 0};dist.ComputeFrame=function(dst,src,distortEffect,letterbox,ticks,alpha,erase,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed){var bdst=dst;var bsrc=src;var dstStride=1024;var srcStride=1024;var x=0,y=0;for(y=0;y<224;y++){S=dist.Distorter(y,ticks,distortEffect,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed);L=y;if(distortEffect==3){L=S}for(x=0;x<256;x++){var bpos=x*4+y*dstStride;if(y<letterbox||y>224-letterbox){bdst[bpos+2]=0;bdst[bpos+1]=0;bdst[bpos+0]=0;continue}var dx=x;if(distortEffect==1||distortEffect==2){dx=(x+S)%256;if(dx<0)dx=256+dx;if(dx>255)dx=256-dx}var spos=dx*4+L*srcStride;if(erase==1){bdst[bpos+3]=255;bdst[bpos+2]=alpha*bsrc[spos+2];bdst[bpos+1]=alpha*bsrc[spos+1];bdst[bpos+0]=alpha*bsrc[spos+0]}else{bdst[bpos+3]=255;bdst[bpos+2]+=alpha*bsrc[spos+2];bdst[bpos+1]+=alpha*bsrc[spos+1];bdst[bpos+0]+=alpha*bsrc[spos+0]}}}return bdst};dist.test=function(effs){dist.tickssy+=1;var blankcanvas=document.createElement("canvas");blankcanvas.width=dist.bfx.w;blankcanvas.height=dist.bfx.h;var ctx=blankcanvas.getContext("2d");var imageData=ctx.getImageData(0,0,dist.bfx.w,dist.bfx.h);var data=imageData.data;dist.bfx.effect=dist.bfx.effectsrom[effs];dist.bfx.getDuration();dist.ComputeFrame(data,dist.bdata,dist.bfx.getType(),0,dist.tickssy,dist.alpha,0,dist.bfx.getAmplitude(),dist.bfx.getAmplitudeAcceleration(),dist.bfx.getFrequency(),dist.bfx.getFrequencyAcceleration(),dist.bfx.getCompression(),dist.bfx.getCompressionAcceleration(),dist.bfx.getSpeed());ctx.putImageData(imageData,0,0);dist.fctx.drawImage(blankcanvas,0,0,dist.bfx.w,dist.bfx.h,screen.GSTARTX,screen.GSTARTY,screen.GWIDTH,screen.GHEIGHT+31)}};</script>

<script>
battle={};battle.atk={};battle.skl={};battle.action={};battle.effect={};battle.setup=function(){battle.maxlevel=99;battle.herotoshowstatus=false;battle.order=new Array;battle.heroes=clone(resources.hms.Heroes);for(var hero in battle.heroes){battle.initHero(battle.heroes[hero])}};battle.initHero=function(hero){hero["side"]="hero";hero["xp"]=0;hero["level"]=0;hero["xpnextlevel"]=hero["ExpToLevel"][0]*hero["level"]+hero["ExpToLevel"][1];hero["skill"]=[];hero["hp"]=0;hero["hpmax"]=0;hero["mod"]={st:0,dx:0,iq:0};hero["equiped"]={weapon:false,armor:false};battle.uplevel(hero,1,true)};battle.initMonster=function(monster){monster["side"]="monster";monster["level"]=0;monster["skill"]=[];monster["hp"]=0;monster["hpmax"]=0;battle.setMonsterLevel(monster);if(!("prob"in monster)){var prob={};var totalprob=0;var atks=clone(monster["skill"]);atks.push("atk");for(var i=0;i<atks.length;i++){if(i==atks.length-1){prob[atks[i]]=1-totalprob}else{totalprob+=1/atks.length;prob[atks[i]]=1/atks.length}}monster["prob"]=prob}monster["xpreward"]=monster["ExpToLevel"][0]*monster["level"]+monster["ExpToLevel"][1];monster["dead"]=false};battle.uplevel=function(hero,leveltoup,silent){var silent=typeof silent==="undefined"?false:silent;var currlvl=hero["level"];if(leveltoup>currlvl){hero["st"]=Math.floor(leveltoup*hero["baseStats"]["st"]/battle.maxlevel);hero["dx"]=Math.floor(leveltoup*hero["baseStats"]["dx"]/battle.maxlevel);hero["iq"]=Math.floor(leveltoup*hero["baseStats"]["iq"]/battle.maxlevel);hero["hp"]=Math.floor(leveltoup*hero["baseStats"]["hp"]/battle.maxlevel);hero["hpmax"]=Math.floor(leveltoup*hero["baseStats"]["hp"]/battle.maxlevel);for(var i=currlvl+1;i<leveltoup+1;i++){var lvl=i.toString();var text=hero["name"]+" reached level "+lvl+"!";hero["level"]=i;hero["xpnextlevel"]+=hero["ExpToLevel"][0]*hero["level"]+hero["ExpToLevel"][1];if(lvl in hero["Pathway"]){if("learn"in hero["Pathway"][lvl]){var tolearn=hero["Pathway"][lvl]["learn"];for(var stuff in tolearn){hero[stuff].push(tolearn[stuff]);text+="\n"+hero["name"]+" learned "+tolearn[stuff]+"!"}}if("forget"in hero["Pathway"][lvl]){var toforget=hero["Pathway"][lvl]["forget"];for(var stuff in toforget){removeA(hero[stuff],toforget[stuff]);text+="\n"+hero["name"]+" forgot "+toforget[stuff]+"!"}}}if(!silent){actions.showText(text)}}}};battle.setMonsterLevel=function(mon){var mlevel=0;for(var i=0;i<player.party.length;i++){mlevel+=battle.hero[i].level}mlevel=Math.floor(mlevel/player.party.length);mlevel+=battle.diceroll(1)+player.party.length;mlevel=Math.max(mlevel-3,1);battle.uplevel(mon,mlevel,true)};battle.selectFromProb=function(probdict){var random=Math.random();var range=0;for(atsk in probdict){if(range<=random&&random<=range+probdict[atsk])return atsk;range+=probdict[atsk]}};battle.diceroll=function(n){var i=n;var result=0;while(i>0){i--;result+=Math.floor(Math.random()*3+1)}return result};battle.action.atk=function(){actions.showText("attack!")};battle.action.skill=function(skill){actions.showText(skill)};battle.start=function(monsterlist){battle.holdAtomStack=engine.atomStack;engine.atomStack=new Array;battle.monster=[];battle.hero=[];battle.waitherodecision=false;battle.bchToAttack=[];battle.ended=false;battle.xpreward=0;if(monsterlist.length>1){dist.efnumb[0]=31}for(var i=0;i<player.party.length;i++){battle.hero[i]=battle.heroes[player.party[i]]}for(var i=0;i<monsterlist.length;i++){battle.monster[i]=clone(resources.hms.Monsters[monsterlist[i]]);battle.initMonster(battle.monster[i])}battle.skills=resources.hms.Skills;battle.setOrderStack();actions.fadeIn("blackFadeIn;doNotKeep")};battle.resolveOrder=function(){if(battle.ended){return}if(!battle.waitherodecision){if(battle.order.length>0){battle.bchToAttack=battle.order.shift();if(battle.bchToAttack[1]=="hero"){console.log("hero attack");if(battle.resolveIfSideDead()){return}battle.herodecision="action";actions.questionBox("attack;skill");battle.waitherodecision=true;if(battle.resolveIfSideDead()){return}}else{console.log("monster attack");if(battle.resolveIfSideDead()){return}if(!battle.bchToAttack[0].dead){battle.mAttack(battle.bchToAttack[0])}if(battle.resolveIfSideDead()){return}}}else{if(battle.isPartyAlive()){battle.setOrderStack()}}}else{battle.hAttack(battle.bchToAttack[0])}};battle.resolveIfSideDead=function(){if(!battle.isPartyAlive()){while(battle.order.length>0){battle.order.pop()}battle.ended=true;actions.showText("You died!");battle.end("died");return true}if(!battle.isMonstersAlive()){while(battle.order.length>0){battle.order.pop()}battle.ended=true;actions.showText("You win!");battle.end("win");return true}return false};battle.setOrderStack=function(){while(battle.order.length>0){battle.order.pop()}for(var i=0;i<player.party.length;i++){battle.order.push([battle.hero[i],"hero"])}for(var i=0;i<battle.monster.length;i++){battle.order.push([battle.monster[i],"monster"])}battle.order.sort(function(a,b){if(a[0]["dx"]>b[0]["dx"])return-1;if(a[0]["dx"]<b[0]["dx"])return 1;return 0})};battle.hAct={};battle.hAct.askTarget=function(){engine.questionBoxAnswer=engine.questionBoxUndef;battle.hAct.targetting=true;battle.herodecision="target";var selmon=[];for(var i=0;i<battle.monster.length;i++){if(!battle.monster[i].dead){selmon.push(battle.monster[i])}}if(selmon.length==1){selmon[0].selected=false;battle.hAct.targetting=false;battle.hAct.__target=[selmon[0]];engine.questionBoxAnswer=0;HID.inputs["accept"].active=false;return}for(var i=0;i<selmon.length;i++){selmon[i].selected=false;selmon[i].flash=0;if(i==0){selmon[i].previous=selmon[0];selmon[i].next=selmon[i+1]}else if(i==selmon.length-1){selmon[i].previous=selmon[i-1];selmon[i].next=selmon[i]}else{selmon[i].previous=selmon[i-1];selmon[i].next=selmon[i+1]}}selmon[0].selected=true;battle.hAct.selectedMonster=selmon[0]};battle.hAct.changeSelection=function(next){battle.hAct.selectedMonster.selected=false;battle.hAct.selectedMonster=battle.hAct.selectedMonster[next];battle.hAct.selectedMonster.selected=true};battle.hAct.targetUpdate=function(){if(typeof this.keyPressed==="undefined"){this.keyPressed=0}if(this.keyPressed==0){if(HID.inputs["up"].active){battle.hAct.changeSelection("previous");HID.inputs["up"].active=false;this.keyPressed=32}else if(HID.inputs["left"].active){battle.hAct.changeSelection("previous");HID.inputs["left"].active=false;this.keyPressed=32}else if(HID.inputs["right"].active){battle.hAct.changeSelection("next");HID.inputs["right"].active=false;this.keyPressed=32}else if(HID.inputs["down"].active){battle.hAct.changeSelection("next");HID.inputs["down"].active=false;this.keyPressed=32}else if(HID.inputs["accept"].active){this.selectedMonster.selected=false;battle.hAct.targetting=false;battle.hAct.__target=[battle.hAct.selectedMonster];engine.questionBoxAnswer=0;HID.inputs["accept"].active=false;this.keyPressed=32}else if(HID.inputs["cancel"].active){}}else{this.keyPressed-=4}};battle.hAttack=function(hero){if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="action"){if(engine.questionBoxAnswer==0){battle.hAct.__damage=battle.atk.pts(hero);battle.hAct.__actionType=["hpdown"];battle.hAct.__skill="atk";if(battle.monster.length<=1){battle.hAct.__target=[battle.monster[0]];var __proceed=true}else{battle.hAct.askTarget()}}else if(engine.questionBoxAnswer==1){battle.herodecision="skill";var options=hero["skill"].join(";");options="back;"+options;actions.questionBox(options)}}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="skill"){if(engine.questionBoxAnswer==0){battle.herodecision="action";actions.questionBox("attack;skill")}else{actions.showText(engine.questionBoxAnswerStr);battle.hAct.__damage=battle.skl.pts(hero,engine.questionBoxAnswerStr);battle.hAct.__actionType=battle.skills[engine.questionBoxAnswerStr].effect;battle.hAct.__target=[battle.monster[0]];battle.hAct.__skill=engine.questionBoxAnswerStr;var __proceed=true}}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="target"){var __proceed=true}if(typeof __proceed!=="undefined"){if(__proceed!=false){console.log("attacked");battle.resolveAtk(hero,battle.hAct.__target,battle.hAct.__damage,battle.hAct.__actionType,battle.hAct.__skill);actions.proceedBattleTurn()}}};battle.mAttack=function(mn){var mon=mn;var attack=battle.selectFromProb(mon["prob"]);var damage=0;var actionType=[];var target=[battle.mTarget(mon)];if(attack=="atk"){damage=battle.atk.pts(mon);actionType=["hpdown"]}else{damage=battle.skl.pts(mon,attack);actionType=battle.skills[attack].effect;if(battle.skills[attack].affect=="all")target=battle.hero}if(damage>0){screen.flashMonster(mon,"#eeeeee")}else{screen.shakeMonster(mon)}battle.resolveAtk(mon,target,damage,actionType,attack)};battle.resolveAtk=function(bchSrc,bchVct,dmg,act,skill){for(var j=0;j<bchVct.length;j++){for(var i=0;i<act.length;i++){battle.effect[act[i]](bchSrc,bchVct[j],dmg,skill)}}};battle.effect.hpdown=function(bchsrc,bch,dmg,skill){bch.hp=Math.max(bch["hp"]-dmg,0);if(skill=="atk"){actions.showText(bchsrc.name+" attacked "+bch.name+" and dealt "+dmg+" damage!")}else{actions.showText(bchsrc.name+" used "+skill+" on "+bch.name+" and dealt "+dmg+" damage!")}if(bch.side=="monster"){screen.flashMonster(bch,"#bf0010")}};battle.effect.hpup=function(bchsrc,bch,dmg){bch.hp=Math.min(bch["hp"]+dmg,bch["hpmax"])};battle.mTarget=function(monster){var dead=true;if(monster.target=="splash"){}else if(monster.target=="hero"){var options=battle.hero.length;for(var i=0;i<options;i++){if(battle.hero[i].Leader&&battle.isAlive(battle.hero[i])){return battle.hero[i]}}}else if(monster.target=="weakest"){var minhp=999999999;var index=0;for(var i=0;i<options;i++){if(battle.hero[i].hp<minhp&&battle.hero[i].hp>0){minhp=battle.hero[i]["hp"];index=i}}return battle.hero[index]}var target=0;var options=battle.hero.length;var targetProb={};for(var i=0;i<options;i++){targetProb[i]=1/options}var tries=0;while(dead){tries++;target=battle.selectFromProb(targetProb);dead=!battle.isAlive(battle.hero[target]);if(tries>20){break}}return battle.hero[target]};battle.end=function(battleresult){battle.lastresult=battleresult;for(var i=0;i<battle.hero.length;i++){if(battle.isAlive(battle.hero[i])){var thishero=battle.hero[i];thishero.xp+=Math.floor(battle.xpreward/battle.hero.length);while(thishero.xp>thishero.xpnextlevel){var newlevel=thishero.level+1;battle.uplevel(thishero,newlevel)}}}actions.changeState("map");engine.atomStack.push([function(){engine.atomStack=battle.holdAtomStack},""])};battle.isPartyAlive=function(){var test=0;for(var i=0;i<battle.hero.length;i++){test+=battle.isAlive(battle.hero[i])}return test>0};battle.monsterDies=function(monster){battle.xpreward+=monster.xpreward};battle.isMonstersAlive=function(){var test=0;for(var i=0;i<battle.monster.length;i++){test+=battle.isAlive(battle.monster[i]);if(!battle.isAlive(battle.monster[i])){if(!battle.monster[i].dead){battle.monster[i].dead=true;battle.monsterDies(battle.monster[i])}}}return test>0};battle.isAlive=function(bch){return bch["hp"]>0};battle.atk.pts=function(bch){return battle.diceroll(bch["st"])};battle.skl.pts=function(bch,skill){var baseplus=getkey0(battle.skills[skill],"basep");var plus=getkey0(battle.skills[skill],"plus");var attribut=0;if("atr"in battle.skills[skill])attribut=bch[battle.skills[skill]["atr"]];return Math.max(battle.diceroll(baseplus+attribut)+plus,0)};battle.mApplyState=function(mon,st){for(var k in mon.state[st]){mon[k]=mon.state[st][k]}};battle.update=function(){battle.resolveOrder();if(battle.hAct.targetting){battle.hAct.targetUpdate()}};</script>

<script>
var bootstrap={};window.forceMobile=false;var query=window.location.search.substring(1).split("&");for(var i=0,max=query.length;i<max;i++){if(query[i]==="")continue;var param=query[i].split("=");if(param[0]=="forceMobile"&&(param[1]=="true"||param[1]=="True"||param[1]=="1"))window.forceMobile=true;if(param[0]=="debug"&&(param[1]=="true"||param[1]=="True"||param[1]=="1"))window.addEventListener("unload",function(e){e.preventDefault();jsonGet("http://127.0.0.1:8081/exit.json")},false)}var init=jsonGet(descriptors+"init.json");bootstrap.onLoadDOM=function(){try{var child=document.getElementById("loading");child.parentNode.removeChild(child);document.ontouchmove=function(e){e.preventDefault()};document.getElementsByTagName("canvas")[0].getContext("2d").fillStyle="#FFFFFF";document.getElementsByTagName("canvas")[0].getContext("2d").fillText("LOADING...",64,64);resources.harvest();screen.init();player.setup();camera.setupCanvas(screen.canvas);engine.setup();screen.setEngine(engine);HID.setup(screen);engine.currentLevel=resources["levels"][init["World"]["initLevel"]];screen.printBox.setup(resources.printerset);feedbackEng.setup();title.setup();battle.setup();menus.setAllDrawables();engine.loop();screen.requestAnimationFrame.call(window,function(){screen.loop()});debug.FPS.loop();chars=new charalist;chars.push(player)}catch(err){alert("Error on bootstrap! "+err)}};</script>

</head> 
	
<body onload="bootstrap.onLoadDOM()"> 
        
<div> 
		
<canvas id="viewport" width="416" height="704" style="image-rendering: pixelated"> 
</canvas> 
		
<font id="loading" color="white">  LOADING...
</font> 
        
</div> 
		
<img style="display:none" id="tile" src="img/tile.png"/> 
		
<img style="display:none" id="faceset" src="img/faceset.png"/> 
		
<img style="display:none" id="charasetimg" src="img/charaset.png"/> 
		
<img style="display:none" id="printerimg" src="img/printer.png" /> 
		
<img style="display:none" id="titleimg" src="img/title.png" /> 
		
<img style="display:none" id="monsterbattleimg" src="img/monsterBattleSet.png" /> 
		
<img style="display:none" id="bgimg1" src="img/bgimg1.png" /> 
		
<img style="display:none" id="keys0" src="img/keys0.png" /> 
		
<img style="display:none" id="keys1" src="img/keysexplainer.png" /> 
		
<img style="display:none" id="keys2" src="img/pckeys.png" /> 
		
<img style="display:none" id="controllers" src="img/controllers.png" /> 

        
<audio id="audioStop" src="audio/stop.wav" preload="auto"> 
</audio> 
        
<audio id="audioText" src="audio/TextboxBloop8-Bit.ogg" preload="auto"> 
</audio> 
        
<audio id="audioWord" src="audio/wordBlop.wav" preload="auto"> 
</audio> 

		
<p style="font-family:Helvetica;font-size:20px;" id="log"> log
</p> 



	
</body> 

